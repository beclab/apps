# macos config lifecycle (like librechat api-keys):
# 1) ConfigMap macos-env: first install from .Values; upgrade preserves existing (lookup).
# 2) Init sync: merge ConfigMap (non-empty) > PVC .env > empty, write to appData/macos/config/.env.
# 3) Runtime: VERSION/CDN_HOST from /config/.env; DISK_SIZE/RAM_SIZE/CPU_CORES from env.
---
apiVersion: v1
kind: Service
metadata:
  name: macos-svc
  namespace: {{ .Release.Namespace }}
spec:
  internalTrafficPolicy: Cluster
  ports:
    - name: http
      port: 8006
      protocol: TCP
      targetPort: 8006
    - name: vnc
      port: 5900
      protocol: TCP
      targetPort: 5900
  selector:
    app: macos
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    name: macos
spec:
  replicas: 1
  selector:
    matchLabels:
      app: macos
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: macos
    spec:
      initContainers:
        - name: sync-env-to-pvc
          image: docker.io/beclab/aboveos-busybox:1.37.0
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: macos-env
          command:
            - sh
            - -c
            - |
              # Priority: ConfigMap (non-empty) > PVC file > empty (like librechat api-keys)
              mkdir -p /config
              TMP_FILE="/tmp/macos.env.tmp"
              PVC_TMP="/tmp/pvc.env.tmp"
              if [ -f /config/.env ]; then
                grep -v '^#' /config/.env | grep -v '^$' > "$PVC_TMP" || touch "$PVC_TMP"
              else
                touch "$PVC_TMP"
              fi
              get_pvc_value() {
                local r; r=$(grep "^${1}=" "$PVC_TMP" 2>/dev/null | cut -d'=' -f2- | head -n1); echo "${r:-}"
              }
              : > "$TMP_FILE"
              for key in CDN_HOST VERSION; do
                cm_val=$(printenv "$key" 2>/dev/null || echo "")
                pvc_val=$(get_pvc_value "$key")
                cm_val=$(echo "$cm_val" | sed 's/^["'\'']//;s/["'\'']$//' | xargs)
                pvc_val=$(echo "$pvc_val" | sed 's/^["'\'']//;s/["'\'']$//' | xargs)
                if [ -n "$cm_val" ]; then
                  echo "${key}=${cm_val}" >> "$TMP_FILE"
                elif [ -n "$pvc_val" ]; then
                  echo "${key}=${pvc_val}" >> "$TMP_FILE"
                else
                  echo "${key}=" >> "$TMP_FILE"
                fi
              done
              rm -f "$PVC_TMP"
              mv "$TMP_FILE" /config/.env
          volumeMounts:
            - mountPath: /config
              name: macos-config
      containers:
        - name: macos
          image: beclab/dockurr-macos:2.29-ext
          command:
            - sh
            - -c
            - |
              set -a
              [ -f /config/.env ] && . /config/.env
              set +a
              exec tini -g -- /run/entry.sh
          env:
            - name: DISK_SIZE
              value: "{{ .Values.olaresEnv.DISK_SIZE | default "128G" }}"
            - name: RAM_SIZE
              value: "{{ .Values.olaresEnv.RAM_SIZE | default "4G" }}"
            - name: CPU_CORES
              value: "{{ .Values.olaresEnv.CPU_CORES | default "1" }}"
          ports:
            - containerPort: 8006
              name: http
              protocol: TCP
            - containerPort: 5900
              name: vnc
              protocol: TCP
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
          volumeMounts:
            - mountPath: /storage
              name: storage
            - mountPath: /config
              name: macos-config
            - mountPath: /dev/kvm
              name: dev-kvm
            - mountPath: /dev/net/tun
              name: dev-tun
          resources:
            requests:
              cpu: "4"
              memory: 6Gi
            limits:
              cpu: "12"
              memory: 24Gi
      terminationGracePeriodSeconds: 120
      volumes:
        - hostPath:
            path: '{{ .Values.userspace.appCache }}'
            type: DirectoryOrCreate
          name: storage
        - hostPath:
            path: '{{ .Values.userspace.appData }}/config'
            type: DirectoryOrCreate
          name: macos-config
        - hostPath:
            path: /dev/kvm
          name: dev-kvm
        - hostPath:
            path: /dev/net/tun
            type: CharDevice
          name: dev-tun
