apiVersion: apps/v1
kind: Deployment
metadata:
  name: jupyterhub
  namespace: "{{ .Release.Namespace }}"
  labels:
    io.kompose.service: jupyterhub
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: jupyterhub
  strategy:
    type: Recreate
  revisionHistoryLimit: 3
  template:
    metadata:
      labels:
        io.kompose.service: jupyterhub
    spec:
      serviceAccountName: jupyterhub-service-account
      containers:
        - name: jupyterhub
          image: "beclab/jupyterhub-jupyterhub:5.4.3"
          ports:
            - containerPort: 8000
              protocol: TCP
            - containerPort: 8081
              protocol: TCP
          env:
            - name: TZ
              value: Etc/UTC
            - name: JUPYTERHUB_CRYPT_KEY
              value: "a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6"
            - name: JUPYTERHUB_COOKIE_SECRET
              value: "f6e5d4c3b2a1f6e5d4c3b2a1f6e5d4c3b2a1f6e5d4c3b2a1f6e5d4c3b2a1"
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POSTGRES_HOST
              value: "{{ .Values.postgres.host }}"
            - name: POSTGRES_PORT
              value: "{{ .Values.postgres.port }}"
            - name: POSTGRES_DB
              value: "{{ .Values.postgres.databases.jupyterhub }}"
            - name: POSTGRES_USER
              value: "{{ .Values.postgres.username }}"
            - name: POSTGRES_PASSWORD
              value: "{{ .Values.postgres.password }}"
            - name: USERSPACE_APPDATA
              value: "{{ .Values.userspace.appData }}/jupyterhub"
          volumeMounts:
            - name: jupyterhub-config
              mountPath: /etc/jupyterhub/jupyterhub_config.py
              subPath: jupyterhub_config.py
          command: ["/bin/bash"]
          args:
            - -c
            - |
              set -e
              echo "Installing dependencies..."
              for i in {1..3}; do
                if pip install --no-cache-dir jupyterhub-nativeauthenticator jupyterhub-kubespawner psycopg2-binary; then
                  echo "Dependencies installed successfully"
                  break
                else
                  echo "Attempt $i failed, retrying in 5 seconds..."
                  sleep 5
                fi
              done
              echo "Starting JupyterHub..."
              # Clean up any existing processes and free ports
              pkill -9 -f jupyterhub || true
              pkill -9 -f configurable-http-proxy || true
              sleep 3
              # Verify ports are free
              if command -v lsof >/dev/null 2>&1; then
                lsof -ti:8000 | xargs kill -9 2>/dev/null || true
                lsof -ti:8081 | xargs kill -9 2>/dev/null || true
                sleep 2
              fi
              # Start JupyterHub
              # The Hub API will bind to 127.0.0.1:8081 as configured
              # ConfigProxy will connect to it via localhost
              exec jupyterhub -f /etc/jupyterhub/jupyterhub_config.py --ip=0.0.0.0 --port=8000
          livenessProbe:
            httpGet:
              path: /hub/health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
            successThreshold: 1
          readinessProbe:
            httpGet:
              path: /hub/health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          resources:
            requests:
              memory: "1Gi"
              cpu: "1000m"
            limits:
              memory: "2Gi"
              cpu: "2"
      volumes:
        - name: jupyterhub-config
          configMap:
            name: jupyterhub-config
---
apiVersion: v1
kind: Service
metadata:
  name: jupyterhub-svc
  namespace: "{{ .Release.Namespace }}"
  labels:
    io.kompose.service: jupyterhub
spec:
  selector:
    io.kompose.service: jupyterhub
  ports:
    - name: jupyterhub-hub
      protocol: TCP
      port: 8000
      targetPort: 8000
    - name: jupyterhub-ks
      protocol: TCP
      port: 8081
      targetPort: 8081
