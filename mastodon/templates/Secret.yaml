{{- $mastodon_default_secret := (lookup "v1" "Secret" .Release.Namespace "mastodon-default") -}}
{{- $mastodon_admin_password := "" -}}
{{- $secret_key_base := "" -}}
{{- $otp_secret := "" -}}
{{- $active_record_encryption_deterministic_key := "" -}}
{{- $active_record_encryption_key_derivation_salt := "" -}}
{{- $active_record_encryption_primary_key := "" -}}
{{- $existing_deterministic_key := "" -}}
{{- $existing_derivation_salt := "" -}}
{{- $existing_primary_key := "" -}}
{{ if $mastodon_default_secret -}}
{{- $mastodon_admin_password = (index $mastodon_default_secret "data" "MASTODON_ADMIN_PASSWORD") -}}
{{- $secret_key_base = (index $mastodon_default_secret "data" "SECRET_KEY_BASE") -}}
{{- $otp_secret = (index $mastodon_default_secret "data" "OTP_SECRET") -}}
{{- $existing_deterministic_key = (index $mastodon_default_secret "data" "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY") | default "" -}}
{{- $existing_derivation_salt = (index $mastodon_default_secret "data" "ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT") | default "" -}}
{{- $existing_primary_key = (index $mastodon_default_secret "data" "ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY") | default "" -}}
{{- if and $existing_deterministic_key (ne $existing_deterministic_key "") -}}
{{- $active_record_encryption_deterministic_key = $existing_deterministic_key -}}
{{- else -}}
{{- $active_record_encryption_deterministic_key = randAlphaNum 32 | b64enc -}}
{{- end -}}
{{- if and $existing_derivation_salt (ne $existing_derivation_salt "") -}}
{{- $active_record_encryption_key_derivation_salt = $existing_derivation_salt -}}
{{- else -}}
{{- $active_record_encryption_key_derivation_salt = randAlphaNum 32 | b64enc -}}
{{- end -}}
{{- if and $existing_primary_key (ne $existing_primary_key "") -}}
{{- $active_record_encryption_primary_key = $existing_primary_key -}}
{{- else -}}
{{- $active_record_encryption_primary_key = randAlphaNum 32 | b64enc -}}
{{- end -}}
{{ else -}}
{{- if and .Values.olaresEnv .Values.olaresEnv.USER_PASSWORD -}}
{{- $mastodon_admin_password = .Values.olaresEnv.USER_PASSWORD | b64enc -}}
{{- else -}}
{{- $mastodon_admin_password = "admin1234" | b64enc -}}
{{- end -}}
{{- $secret_key_base = randAlphaNum 64 | b64enc}}
{{- $otp_secret = randAlphaNum 32 | b64enc}}
{{- $active_record_encryption_deterministic_key = randAlphaNum 32 | b64enc}}
{{- $active_record_encryption_key_derivation_salt = randAlphaNum 32 | b64enc}}
{{- $active_record_encryption_primary_key = randAlphaNum 32 | b64enc}}
{{- end -}}

{{- $mastodon_redis_secret := (lookup "v1" "Secret" .Release.Namespace "mastodon-redis") -}}
{{- $redis_password := "" -}}
{{ if $mastodon_redis_secret -}}
{{- $redis_password = (index $mastodon_redis_secret "data" "redis-password") -}}
{{ else -}}
{{- $redis_password = randAlphaNum 16 | b64enc}}
{{- end -}}

---
apiVersion: v1
kind: Secret
metadata:
  name: mastodon-default
  namespace: "{{ .Release.Namespace }}"
  labels:
    app.kubernetes.io/name: mastodon
    helm.sh/chart: mastodon-0.1.2
    app.kubernetes.io/instance: mastodon
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: mastodon
data:
  MASTODON_ADMIN_PASSWORD: "{{ $mastodon_admin_password }}"
  SECRET_KEY_BASE: "{{ $secret_key_base }}"
  OTP_SECRET: "{{ $otp_secret }}"
  ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "{{ $active_record_encryption_deterministic_key }}"
  ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "{{ $active_record_encryption_key_derivation_salt }}"
  ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "{{ $active_record_encryption_primary_key }}"
---
apiVersion: v1
kind: Secret
metadata:
  name: mastodon-redis
  namespace: "{{ .Release.Namespace }}"
  labels:
    app.kubernetes.io/name: redis
    helm.sh/chart: redis-17.3.16
    app.kubernetes.io/instance: mastodon
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  redis-password: "{{ $redis_password }}"
