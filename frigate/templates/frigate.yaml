apiVersion: apps/v1
kind: Deployment
metadata:
  name: frigate
  namespace: {{ .Release.Namespace }}
  labels:
    io.kompose.service: frigate
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: frigate
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: frigate
    spec:
      containers:
        - name: frigate
          image: "docker.io/beclab/blakeblackshear-frigate:0.16.3"
          env:
            - name: TZ
              value: {{ .Values.timezone | default "Etc/UTC" | quote }}
            - name: FRIGATE_RTSP_PASSWORD
              value: {{ .Values.rtspPassword | default "frigate" | quote }}
          resources:
            requests:
              cpu: {{ .Values.resources.requests.cpu | default "500m" }}
              memory: {{ .Values.resources.requests.memory | default "1Gi" }}
            limits:
              cpu: {{ .Values.resources.limits.cpu | default "2000m" }}
              memory: {{ .Values.resources.limits.memory | default "5Gi" }}
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
            - name: rtsp
              containerPort: 8554
              protocol: TCP
            - name: rtsp-udp
              containerPort: 8555
              protocol: UDP
          volumeMounts:
            - mountPath: /config
              name: frigate-config
              subPath: config
            - mountPath: /media/frigate
              name: frigate-media
              subPath: media
            - mountPath: /tmp/cache
              name: frigate-cache
            - mountPath: /dev/shm
              name: shm
            {{- if .Values.usb.enabled }}
            - mountPath: /dev/bus/usb
              name: usb-devices
            {{- end }}
          securityContext:
            privileged: {{ .Values.securityContext.privileged | default false }}
            capabilities:
              add:
                - SYS_ADMIN
                {{- if .Values.usb.enabled }}
                - SYS_RAWIO
                {{- end }}
      restartPolicy: Always
      volumes:
        - name: frigate-config
          hostPath:
            type: DirectoryOrCreate
            {{- if .Values.sysVersion }}
              {{- if semverCompare ">=1.12.3-0" (toString .Values.sysVersion) }}
            path: '{{ .Values.userspace.appData }}'
              {{- else }}
            path: '{{ .Values.userspace.appData }}/frigate'
              {{- end }}
            {{- else }}
            path: '{{ .Values.userspace.appData }}/frigate'
            {{- end }}
        - name: frigate-media
          hostPath:
            type: DirectoryOrCreate
            {{- if .Values.sysVersion }}
              {{- if semverCompare ">=1.12.3-0" (toString .Values.sysVersion) }}
            path: '{{ .Values.userspace.appCache }}'
              {{- else }}
            path: '{{ .Values.userspace.appCache }}/frigate'
              {{- end }}
            {{- else }}
            path: '{{ .Values.userspace.appCache }}/frigate'
            {{- end }}
        - name: frigate-cache
          emptyDir:
            sizeLimit: {{ .Values.cacheSize | default "4Gi" }}
        - name: shm
          emptyDir:
            medium: Memory
            sizeLimit: {{ .Values.shmSize | default "2Gi" }}
        {{- if .Values.usb.enabled }}
        - name: usb-devices
          hostPath:
            path: /dev/bus/usb
            type: Directory
        {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: frigate
  namespace: {{ .Release.Namespace }}
  labels:
    io.kompose.service: frigate
spec:
  ports:
    - name: "5000"
      port: 5000
      targetPort: 5000
    - name: "8554"
      port: 8554
      targetPort: 8554
    - name: "8555"
      port: 8555
      targetPort: 8555
      protocol: UDP
  selector:
    io.kompose.service: frigate
status:
  loadBalancer: {}

