---
apiVersion: batch/v1
kind: Job
metadata:
  name: affine-migration
  namespace: '{{ .Release.Namespace }}'
  labels:
    app: affine-migration
spec:
  backoffLimit: 6
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: affine-migration
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: "docker.io/beclab/wait-for:0.1.0"
        args:
          - '-it'
          - >-
            {{ .Values.postgres.host }}:{{ .Values.postgres.port }}
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      - name: wait-for-redis
        image: "docker.io/beclab/wait-for:0.1.0"
        args:
          - '-it'
          - >-
            redis-svc:6379
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        imagePullPolicy: IfNotPresent
      containers:
      - name: affine-migration
        image: "beclab/toeverything-affine:0.25.7"
        command: ['sh', '-c', 'set -e && echo "Starting migration..." && ls -la ./scripts/ && node ./scripts/self-host-predeploy.js && echo "Migration completed successfully"']
        env:
        - name: DATABASE_URL
          value: "postgresql://{{ .Values.postgres.username }}:{{ .Values.postgres.password }}@{{ .Values.postgres.host }}:{{ .Values.postgres.port }}/{{ .Values.postgres.databases.affine }}"
        - name: REDIS_SERVER_HOST
          value: "redis-svc"
        - name: AFFINE_INDEXER_ENABLED
          value: "false"
        resources:
          limits:
            cpu: "1"
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - mountPath: /root/.affine/config
          name: config
      volumes:
      - hostPath:
          {{- if .Values.sysVersion }}
            {{- if semverCompare ">=1.12.3-0" (toString .Values.sysVersion) }}
          path: '{{ .Values.userspace.appData }}/config'
            {{- else }}
          path: '{{ .Values.userspace.appData }}/affine/config'
            {{- end }}
          {{- else }}
          path: '{{ .Values.userspace.appData }}/affine/config'
          {{- end }}
          type: DirectoryOrCreate
        name: config

